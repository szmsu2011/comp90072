---
title: "Respiratory Rate Determination by ECG Monitoring"
author: "Stephen Su, 844503, COMP90072"
output:
  pdf_document:
    keep_tex: true
    fig_caption: yes
    number_sections: yes
    extra_dependencies:
      algorithm: null
      algorithmic: null
  css: style.css
bibliography: refs.bib
csl: apa.csl
urlcolor: blue
---

<style type="text/css">

body {
  font-family: serif;
  text-align: justify;
}

</style>

```{r setup, include = FALSE}
library(knitr)
opts_chunk$set(
  message = FALSE, warning = FALSE, echo = FALSE, dpi = 500,
  fig.height = 4, fig.align = "center", comment = "#>",
  dev.args = list(png = list(type = "cairo"))
)
```

```{r lib, include = FALSE}
library(tidyverse)
library(patchwork)
library(rlang)
library(zoo)
r_source <- list.files("../R", full.names = TRUE)
map(r_source[str_detect(r_source, "\\.R$")], source)
```

```{r code, include = FALSE, cache = FALSE}
read_chunk("report.R")
```

# Introduction

## Background

Pneumonia is the deadliest infectious disease to children under the age of 5, responsible for 740,180 deaths under 5 as of 2019 [@WHO2022]. The worsening symptoms of pneumonia can rapidly become life-threatening for young children if not treated on time. Nevertheless, the early stage of pneumonia with young children is often confused with other less serious respiratory disease with similar symptoms. On the other hand, a medical institution cannot provide comprehensive monitoring to all its patients for all potential symptoms of pneumonia due to limitation of resources. Thus it is of interest to develop light-weight, non-evasive methods for detecting the most common symptoms of pneumonia, as an early warning to serve as an indication of a need for further medical interventions.

In a research outlined in @Shamoon2004, tachypnoea (average respiratory rate > 50 per minute) is one of the critical indicators of pneumonia in young children. However, the high volatility of breath rate in children poses a major challenge for manual counting that is both time-consuming and prone to error. In contrary, automated respiratory monitoring often involves machine-measurement of chest/abdomen movement or nasal airflow that are resource-costly and possibly invasive such that the discomfort from wearing the equipment might adversely affect its accuracy.

A potential solution to the problem above arises from the phenomenon of *respiratory sinus arrhythmia*, such that the instantaneous heart rates increase with inspiration and decrease during expiration [@Larsen2010], by monitoring the periodicity of variation in the heart rate, it may be possible to determine one's respiratory rate with a simple, non-evasive method, such as by a pulse oximeter that is resource-friendly. As such, this project attempts to develop an efficient *predictive* algorithm to accurately and precisely determine respiratory rate from heart rate, as well as briefly discuss its limitations and direction for future works.

## The data

The *apnea-ECG database* [@penzel2000] on *PhysioNet* [@goldberger2000] provides sufficiently large data sets of approximately eight hours long records of electrocardiogram and respiratory signals for eight subjects in a study for *sleep apnea*. The eight records consist of 100Hz signal from the electrocardiogram (ECG), respiratory effort from chest/abdomen movements, nasal airflow, and blood O$_2$ saturation over time.

A major concern of using such data is the misalignment of objective for the researches. Study for apnea typically involves subjects with airway obstruction, a factor that must be considered for prior to building our model. Under the presumption that, subjects in our data might sometimes stop breathing, the response variable of interest should be robust from the presence of apnea. Therefore, the model will focus on exploring the algorithm for determining the respiratory rate from the ECG signal as a predictor for the respiratory rate implied by chest movements, assuming that for living humans, respiratory efforts are always present.

This study will divide records from the eight subjects into two sets:

  - Subjects a01, a02, a03, a04 and b01 form the *training set*.
  - Subjects c01, c02 and c03 form the *test set* for evaluation.

\newpage

# Methodologies and implementation

## Data wrangling

### Processing ECG signals

The ECG signal does not provide the heart rate directly. Instead, it is a time series of varying electric potential that controls the rhythm of the contraction and relaxation of the heart muscle, with a magnitude of approximately 0.5mV in absolute value. Such a signal is often masked by unwanted noise, such as electric signals from pectoral muscle movement, creating a challenge in computing heart rate from the ECG signal.

```{r ecg-noise, fig.height = 3.2, fig.cap = "Left: sudden spike in noise; right: frequency spectrum of the ECG signal"}
```

\begin{algorithm}
\caption{5-20Hz band-pass filter with fast Fourier transform}
\begin{algorithmic}[1]
\STATE Take $\mathbf{x} \in \mathbb{R}^n$ as the 100-Hz input
\STATE Obtain $\mathbf{y}$ by fast Fourier transform on $\mathbf{x}$
\FOR{$t = 1, ..., n$}
\STATE $y_t \leftarrow \sum_{k = 1}^n{x_k}\text{exp}(-2\pi i(k - 1)(t - 1) / n)$
\ENDFOR
\STATE Zero corresponding (Nyquist) frequency bins for 0-5, 20-50Hz
\FOR{$t = 1, ..., n \land (t \in (0.2n, 0.8n) \lor t > 0.95n \lor t < 0.05n)$}
\STATE $y_t \leftarrow 0 + 0i$
\ENDFOR
\STATE Obtain $\mathbf{z}$ by normalised inverse fast Fourier transform on $\mathbf{y}$
\FOR{$t = 1, ..., n$}
\STATE $z_t \leftarrow \sum_{k = 1}^n{y_k}\text{exp}(2\pi i(k - 1)(t - 1) / n) / n$
\ENDFOR
\RETURN $\text{Re}(\mathbf{z}) \in \mathbb{R}^n$ as the 100-Hz output
\end{algorithmic}
\end{algorithm}

\begin{algorithm}
\caption{R peak timestamping with phase correction}
\begin{algorithmic}[1]
\STATE Take the original $\mathbf{x} \in \mathbb{R}^n$ and the filtered $\mathbf{z} \in \mathbb{R}^n$ as the 100-Hz inputs
\STATE Set moving threshold $\mathbf{b}$ as half of rolling maximum
\STATE $(b_t | t = 1, ..., 100) \leftarrow (+\infty)_{\times 100}$
\FOR{$t = 101, ..., n$}
\STATE $b_t \leftarrow \frac{1}{2}\text{max}\{z_{t - 100}, ..., z_t\}$
\ENDFOR
\STATE Create thresholding indicator $\boldsymbol{\iota^{(1)}}$
\FOR{$t = 1, ..., n$}
\STATE $\iota^{(1)}_t \leftarrow I(z_t > \text{max}\{b_t, F^{-1}_{Z}(0.95)\})$
\ENDFOR
\STATE Create concave-peak indicator $\boldsymbol{\iota^{(2)}}$
\FOR{$t = 1, n$}
\STATE $\iota^{(2)}_t \leftarrow 0$
\ENDFOR
\FOR{$t = 2, ..., n - 1$}
\STATE $\iota^{(2)}_t \leftarrow I[I(z_{t + 1} - z_t > 0) - I(z_t - z_{t - 1} > 0) = -1]$
\ENDFOR
\STATE Preliminary timestamps for R peak $\mathbf{p} \leftarrow (t = 1, ..., n | \iota^{(1)}_t \land \iota^{(2)}_t \text{ is True})$
\STATE Remove abnormal timestamps in $\mathbf{p}$ with R-R intervals of < 300ms
\STATE Correct phase-shifts caused by fast Fourier transform
\FOR{$t \in \{\mathbf{p}\}$}
\STATE $p | p = t \leftarrow \text{argmax}_{i = t - 4, ..., t, ..., t + 4} x_i$
\ENDFOR
\RETURN $\mathbf{p}$ the timestamps of the R peak
\end{algorithmic}
\end{algorithm}

### Heart rate derivation from ECG signals

\begin{algorithm}
\caption{Deriving instantaneous heart rates from R peak timestamps}
\begin{algorithmic}[1]
\STATE Take $\mathbf{p}$ the timestamps of the R peak as the input, and $\nu$ as an argument for the frequency unit of $\mathbf{p}$
\STATE $m \leftarrow \text{dim}(\mathbf{p})$ dimension of $\mathbf{p}$
\STATE Compute the R-R intervals $\mathbf{d}$
\STATE $(d_t | t = 1, ..., p_1) \leftarrow (\text{NA})_{\times p_1}$
\STATE $(d_t | t = p_1 + 1, ..., p_{m}) \leftarrow ((p_2 - p_1)_{\times (p_2 - p_1)}, (p_3 - p_2)_{\times (p_3 - p_2)}, ..., (p_{m} - p_{m - 1})_{\times (p_{m} - p_{m - 1})})^\top$
\STATE Convert R-R intervals into heart rates per minute $\mathbf{h}$
\STATE $\mathbf{h} \leftarrow 60 \cdot \nu / \mathbf{d}$
\RETURN $\mathbf{h}$ the heart rates per minute at frequency $\nu$
\end{algorithmic}
\end{algorithm}

\newpage

### Visualising ECG signal processing

```{r ecg-process, fig.height = 11, fig.width = 7}
```

## Modelling rate of breathing by heart rate

### The smoothing spline crossing algorithm

\begin{algorithm}
\caption{Smoothing spline crossing for counting cycles of nonstationary pseudosinusoidal oscillations, for varying heart rates/chest movements}
\begin{algorithmic}[1]
\STATE Take a time series vector $\mathbf{a}$ at any frequency, and the optional argument $\lambda$ the regularisation parameter
\STATE $\mathbf{t} \leftarrow (1, ..., \text{dim}(\mathbf{a}))^\top$ as the indexing vector
\STATE Construct B-spline bases $\mathbf{B}$ derived from natural cubic spline bases about all possible knots of $\mathbf{t}$
\STATE Penalty matrix $\boldsymbol{\Omega} \leftarrow \{\omega_{jk} = \int_T {B_j^{''}(s)B_k^{''}(s)}ds | B_j(t_i) = (\mathbf{B})_{ij}\}$
\IF{argument $\lambda$ is missing}
\STATE $\lambda \leftarrow \text{argmin}_{\lambda > 0} (1 - \text{tr}(\mathbf{B}(\mathbf{B}^\top\mathbf{B} + \lambda\boldsymbol{\Omega})^{-1}\mathbf{B}^\top) / \text{dim}(\mathbf{a}))^{-2}||(\mathbf{I} - \mathbf{B}(\mathbf{B}^\top\mathbf{B} + \lambda\boldsymbol{\Omega})^{-1}\mathbf{B}^\top)\mathbf{a}||^2$
\ENDIF
\STATE $\mathbf{\hat{a}} \leftarrow \mathbf{B}(\mathbf{B}^\top\mathbf{B} + \lambda\boldsymbol{\Omega})^{-1}\mathbf{B}^\top\mathbf{a}$
\STATE Count the number of times the curves $(\mathbf{t}, \mathbf{a})$ and $(\mathbf{t}, \mathbf{\hat{a}})$ cross (equivalent to zero-crossing for $(\mathbf{t}, \mathbf{a} - \mathbf{\hat{a}})$)
\RETURN half of the count obtained above as the approximated cycles
\end{algorithmic}
\end{algorithm}

```{r sszc, fig.height = 3.8}
```

### Model training

\begin{algorithm}
\caption{Deriving breath rate from heart rate based on chest movements}
\begin{algorithmic}[1]
\STATE Take $\mathbf{h}$ the heart rates per minute and $\mathbf{c}$ the chest movements signal (either at 100Hz or down-sampled) where both time series have aligned indices and identical frequency; and optional argument $\lambda_\text{opt}$ (only in model evaluation with test data)
\STATE For both $\mathbf{h}$ and $\mathbf{c}$, remove elements of index where $c_t = \text{NA}$
\FOR{each record of all the subjects}
\STATE Partition each of $\mathbf{h}$ and $\mathbf{c}$ into segments of 60-second data
\ENDFOR
\STATE Drop the remainder (last segment), which is less than 60 seconds
\IF{$\mathbf{h}$ and $\mathbf{c}$ for more than one subject is input}
\STATE Bind $\mathbf{h}$ and $\mathbf{c}$ of all subjects together
\ENDIF
\FOR{each 60-second segment of $\mathbf{c}$}
\STATE Pass each minute of $\mathbf{c}$ into Algorithm 4 (the smoothing spline crossing, without specifying $\lambda$) to compute the true rate of breath based on chest movements, and output $\rightarrow \mathbf{r}$
\ENDFOR
\IF{argument $\lambda_\text{opt}$ is missing}
\STATE $\lambda_\text{opt} \leftarrow \text{argmin}_{\lambda > 0} ||\mathbf{r} - \hat{f}(\mathbf{h}; \lambda)||^2$ where $\hat{f}$ is the Algorithm 4: applied on each minute of $\mathbf{h}$ given $\lambda$
\ENDIF
\STATE $\hat{\lambda}_\text{opt} \leftarrow \lambda_\text{opt}$: if its value is obtained by Step 14 $\hat{\lambda}_\text{opt}$ is the estimate of $\lambda_\text{opt}$ derived from the training data; otherwise, if $\lambda_\text{opt}$ is passed as an argument, then the purpose of this algorithm is model testing
\FOR{each 60-second segment of $\mathbf{h}$}
\STATE Pass each minute of $\mathbf{h}$ into Algorithm 4 (with argument of $\lambda = \hat{\lambda}_\text{opt}$) to compute the derived rate of breath from heart rate, and output $\rightarrow \mathbf{\hat{r}}$ which is the model's estimate of $\mathbf{r}$: the chest rate of breath
\ENDFOR
\RETURN data matrix $(\mathbf{r}, \mathbf{\hat{r}})$, a bi-variate time series (minutely), $\mathbf{r} :=$ "count of breaths by chest movements (observations)" and $\mathbf{\hat{r}} :=$ "number of breaths derived by cardio-activities of that minute (fitted values)", and most importantly $\hat{\lambda}_\text{opt}$ the trained parameter for our final model!
\end{algorithmic}
\end{algorithm}

## Model diagnostics

## Model evaluation

\newpage

# Appendix: workflow, code and output

## Source code

The source codes for the functions used in the workflow are in the `.R` files at [/R](https://github.com/szmsu2011/comp90072/blob/main/R).

## Data wrangling and signal processing

```{r data, echo = TRUE, eval = FALSE}
```

## Model training

```{r train, echo = TRUE}
```

## Model diagnostics

```{r diag, echo = TRUE}
```

## Model evaluation

```{r eval, echo = TRUE}
```

\newpage

# References
