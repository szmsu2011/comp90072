---
title: "Respiratory Rate Determination by ECG Monitoring"
author: "Stephen Su, 844503, COMP90072"
output:
  pdf_document:
    keep_tex: true
    fig_caption: yes
    number_sections: yes
    extra_dependencies:
      algorithm: null
      algorithmic: null
  css: style.css
bibliography: refs.bib
csl: apa.csl
urlcolor: blue
---

<style type="text/css">

body {
  font-family: serif;
  text-align: justify;
}

</style>

```{r setup, include = FALSE}
library(knitr)
opts_chunk$set(
  message = FALSE, warning = FALSE, echo = FALSE, dpi = 500,
  fig.height = 4, fig.align = "center", comment = "#>",
  dev.args = list(png = list(type = "cairo"))
)
```

```{r lib, include = FALSE}
library(tidyverse)
library(patchwork)
library(rlang)
library(zoo)
r_source <- list.files("../R", full.names = TRUE)
map(r_source[str_detect(r_source, "\\.R$")], source)
```

```{r code, include = FALSE, cache = FALSE}
read_chunk("report.R")
```

# Introduction

## Background

Pneumonia is the deadliest infectious disease to children under the age of 5, responsible for 740,180 deaths under 5 as of 2019 [@WHO2022]. The worsening symptoms of pneumonia can rapidly become life-threatening for young children if not treated on time. Nevertheless, the early stage of pneumonia with young children is often confused with other less serious respiratory disease with similar symptoms. On the other hand, a medical institution cannot provide comprehensive monitoring to all its patients for all potential symptoms of pneumonia due to limitation of resources. Thus it is of interest to develop light-weight, non-evasive methods for detecting the most common symptoms of pneumonia, as an early warning to serve as an indication of a need for further medical interventions.

In a research outlined in @Shamoon2004, tachypnoea (average respiratory rate > 50 per minute) is one of the critical indicators of pneumonia in young children. However, the high volatility of breath rate in children poses a major challenge for manual counting that is both time-consuming and prone to error. In contrary, automated respiratory monitoring often involves machine-measurement of chest/abdomen movement or nasal airflow that are resource-costly and possibly invasive such that the discomfort from wearing the equipment might adversely affect its accuracy.

A potential solution to the problem above arises from the phenomenon of *respiratory sinus arrhythmia*, such that the instantaneous heart rates increase with inspiration and decrease during expiration [@Larsen2010], by monitoring the periodicity of variation in the heart rate, it may be possible to determine one's respiratory rate with a simple, non-evasive method, such as by a pulse oximeter that is resource-friendly. As such, this project attempts to develop an efficient *predictive* algorithm to accurately and precisely determine respiratory rate from heart rate, as well as briefly discuss its limitations and direction for future works.

## The data

The *apnea-ECG database* [@penzel2000] on *PhysioNet* [@goldberger2000] provides sufficiently large data sets of approximately eight hours long records of electrocardiogram and respiratory signals for eight subjects in a study for *sleep apnea*. The eight records consist of 100Hz signal from the electrocardiogram (ECG), respiratory effort from chest/abdomen movements, nasal airflow, and blood O$_2$ saturation over time.

A major concern of using such data is the misalignment of objective for the researches. Study for apnea typically involves subjects with airway obstruction, a factor that must be considered for prior to building our model. Under the presumption that, subjects in our data might sometimes stop breathing, the response variable of interest should be robust from the presence of apnea. Therefore, the model will focus on exploring the algorithm for determining the respiratory rate from the ECG signal as a predictor for the respiratory rate implied by chest movements, assuming that for living humans, respiratory efforts are always present.

This study will divide records from the eight subjects into two sets:

  - Subjects a01, a02, a03, a04 and b01 form the *training set*.
  - Subjects c01, c02 and c03 form the *test set* for evaluation.

\newpage

# Methodologies and implementation

## Data wrangling

### Processing ECG signals

The ECG signal does not provide the heart rate directly. Instead, it is a time series of varying electric potential that controls the rhythm of the contraction and relaxation of the heart muscle, with a magnitude of approximately 0.5mV in absolute value. Such a signal is often masked by unwanted noise, such as electric signals from pectoral muscle movement, creating a challenge in computing heart rate from the ECG signal.

```{r ecg-noise, fig.height = 3.2, fig.cap = "Left: sudden spike in noise; right: frequency spectrum of the ECG signal"}
```

\begin{algorithm}
\caption{5-20Hz band-pass filter with fast Fourier transform}
\begin{algorithmic}
\STATE Take $\mathbf{x} \in \mathbb{R}^n$ as the 100-Hz input
\STATE Obtain $\mathbf{y}$ by fast Fourier transform on $\mathbf{x}$
\FOR{$t = 1, ..., n$}
\STATE $y_t \leftarrow \sum_{k = 1}^n{x_k}\text{exp}(-2\pi i(k - 1)(t - 1) / n)$
\ENDFOR
\STATE Zero corresponding (Nyquist) frequency bins for 0-5, 20-50Hz
\FOR{$t = 1, ..., n \land (t \in (0.2n, 0.8n) \lor t > 0.95n \lor t < 0.05n)$}
\STATE $y_t \leftarrow 0 + 0i$
\ENDFOR
\STATE Obtain $\mathbf{z}$ by normalised inverse fast Fourier transform on $\mathbf{y}$
\FOR{$t = 1, ..., n$}
\STATE $z_t \leftarrow \sum_{k = 1}^n{y_k}\text{exp}(2\pi i(k - 1)(t - 1) / n) / n$
\ENDFOR
\RETURN $\text{Re}(\mathbf{z}) \in \mathbb{R}^n$ as the 100-Hz output
\end{algorithmic}
\end{algorithm}

\newpage

# Appendix: workflow, code and output

## Source code

The source codes for the functions used in the workflow are in the `.R` files at [/R](https://github.com/szmsu2011/comp90072/blob/main/R).

## Data wrangling and signal processing

```{r data, echo = TRUE, eval = FALSE}
```

## Model training

```{r train, echo = TRUE}
```

## Model diagnostics

```{r diag, echo = TRUE}
```

## Model evaluation

```{r eval, echo = TRUE}
```

\newpage

# References
